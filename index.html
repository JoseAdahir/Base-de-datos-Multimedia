<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Catalog</title>
    <link rel="stylesheet" href="fontawesome/css/all.min.css"> <!-- https://fontawesome.com/ -->
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro&display=swap" rel="stylesheet">
    <!-- https://fonts.google.com/ -->
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/templatemo-video-catalog.css">

</head>

<body>
    <div class="tm-page-wrap mx-auto">
        <div class="position-relative">
            <div class="position-absolute tm-site-header">
                <div class="container-fluid position-relative">
                    <div class="row">
                        <div class="col-5 col-md-8 ml-auto mr-0">
                            <div class="tm-site-nav">
                                <nav class="navbar navbar-expand-lg mr-0 ml-auto" id="tm-main-nav">
                                    <button class="navbar-toggler tm-bg-black py-2 px-3 mr-0 ml-auto collapsed" type="button"
                                        data-toggle="collapse" data-target="#navbar-nav" aria-controls="navbar-nav"
                                        aria-expanded="false" aria-label="Toggle navigation">
                                        <span>
                                            <i class="fas fa-bars tm-menu-closed-icon"></i>
                                            <i class="fas fa-times tm-menu-opened-icon"></i>
                                        </span>
                                    </button>
                                    <div class="collapse navbar-collapse tm-nav" id="navbar-nav">
                                        <ul class="navbar-nav text-uppercase">
                                            
                                                <button type="submit" class="button" id="logout-btn">
                                                Cerrar sesion
                                                </button>
                                                <a class="name-user" id="username-display">Cargando...</a>
                                           
                                        </ul>
                                    </div>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tm-welcome-container text-center text-white">
                <div class="tm-welcome-container-inner">
                    <p class="tm-welcome-text mb-1 text-white">En nuestra biblioteca encontraras todo lo que necesitas</p>
                    <p class="tm-welcome-text mb-1 text-white">Desde libros hasta videos, continua y descubre lo que tenemos</p>
                    <a href="#content" class="btn tm-btn-animate tm-btn-cta tm-icon-down">
                        <span>Continuar</span>
                    </a>
                </div>
            </div>

            <div id="tm-video-container">
                <video autoplay muted loop id="tm-video">
                        <source src="video/biblioteca.mp4" type="video/mp4">
                </video>    
            </div>
            
            <i id="tm-video-control-button" class="fas fa-pause"></i>
        </div>

        <div class="container-fluid">
            <div id="content" class="mx-auto tm-content-container">
                <main>
                    <div class="row">
                        <div class="col-6">
                            <h2 class="tm-page-title mb-4">Nuestro catalogo</h2>       
                        </div>

                         <div class="col-6">
                            <form class="barra-busqueda" id="search-form">
                                <input type="text" placeholder="Buscar..." id="search-input">
                                <button type="submit">
                                    <i class="fa fa-search"></i>
                                </button>
                                <button type="button" id="clear-search-btn">
                                    <i class="fa fa-times"></i>
                                </button>
                            </form>
                        </div>
                        
                        <!-- Seccion de filtros -->
                        <div class="tm-categories-container">
                                <h3 class="tm-text-primary tm-categories-text">Categorias:</h3>
                                <ul class="nav tm-category-list">
                                    <li class="nav-item tm-category-item"><a href="#!" class="nav-link tm-category-link active" data-tipo="all">Todos</a></li>
                                    <li class="nav-item tm-category-item"><a href="#!" class="nav-link tm-category-link" data-tipo="libro">Libros</a></li>
                                    <li class="nav-item tm-category-item"><a href="#!" class="nav-link tm-category-link" data-tipo="audiolibro">Audio libros</a></li>
                                    <li class="nav-item tm-category-item"><a href="#!" class="nav-link tm-category-link" data-tipo="video">Videos</a></li>
                                    <li class="nav-item tm-category-item"><a href="#!" class="nav-link tm-category-link" data-tipo="musica">Música</a></li>
                                </ul> 
                        </div>
                        
                    </div>
                    <div class="row">
                            <a href="agregar.html" class="button boton-verde my-3">
                                Agregar nuevo contenido
                                <i class="fas fa-plus"></i>
                            </a> 
                     
                    </div>

                    
                   <div class="row tm-catalog-item-list" id="catalogo-lista">
                    
                    </div>

                    
                </main>

                <!-- row -->

                <footer class="row pt-5">
                    
                </footer>
            </div> <!-- tm-content-container -->
        </div>

    </div> <!-- .tm-page-wrap -->

    <script src="js/jquery-3.4.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('authToken');
            const username = localStorage.getItem('authUsername');

            if (!token) {
                // Si no hay token, no está logueado. ¡Fuera de aquí!
                window.location.href = 'login.html';
                return; // Detiene la ejecución
            }

            // Si hay token, muestra el nombre de usuario
            const usernameDisplay = document.getElementById('username-display');
            if (usernameDisplay && username) {
                usernameDisplay.textContent = `Bienvenido, ${username}`;
            }

            // Funcionalidad del botón de cerrar sesión
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    // Limpia el almacenamiento
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('authUsername');
                    // Redirige al login
                    window.location.href = 'login.html';
                });
            }
        });
    </script>

    <script>
        function setVideoSize() {
            const vidWidth = 1920;
            const vidHeight = 1080;
            let windowWidth = window.innerWidth;
            let newVidWidth = windowWidth;
            let newVidHeight = windowWidth * vidHeight / vidWidth;
            let marginLeft = 0;
            let marginTop = 0;

            if (newVidHeight < 500) {
                newVidHeight = 500;
                newVidWidth = newVidHeight * vidWidth / vidHeight;
            }

            if(newVidWidth > windowWidth) {
                marginLeft = -((newVidWidth - windowWidth) / 2);
            }

            if(newVidHeight > 720) {
                marginTop = -((newVidHeight - $('#tm-video-container').height()) / 2);
            }

            const tmVideo = $('#tm-video');

            tmVideo.css('width', newVidWidth);
            tmVideo.css('height', newVidHeight);
            tmVideo.css('margin-left', marginLeft);
            tmVideo.css('margin-top', marginTop);
        }

        $(document).ready(function () {
            /************** Video background *********/

            setVideoSize();

            // Set video background size based on window size
            let timeout;
            window.onresize = function () {
                clearTimeout(timeout);
                timeout = setTimeout(setVideoSize, 100);
            };

            // Play/Pause button for video background      
            const btn = $("#tm-video-control-button");

            btn.on("click", function (e) {
                const video = document.getElementById("tm-video");
                $(this).removeClass();

                if (video.paused) {
                    video.play();
                    $(this).addClass("fas fa-pause");
                } else {
                    video.pause();
                    $(this).addClass("fas fa-play");
                }
            });
        })
    </script>

    <script>
    let allItems = []; // Guarda todos los items del servidor
    const container = document.getElementById('catalogo-lista');
    
    // Variables para guardar el estado actual de los filtros
    let currentCategory = 'all';
    let currentSearchTerm = '';

    // Se ejecuta cuando la página carga
    document.addEventListener('DOMContentLoaded', () => {
        cargarCatalogo();
        setupCategoryListeners();
        setupSearchListener();
        setupClearSearchListener(); // Esta función será modificada
    });

    // 1. Carga TODOS los datos del servidor
    async function cargarCatalogo() {
        try {
            const response = await fetch('/api/catalogo');
            if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
            
            allItems = await response.json();
            applyFilters(); // Muestra los items

        } catch (error) {
            console.error('Error al cargar el catálogo:', error);
            container.innerHTML = '<p class="col-12 text-danger">Error al cargar el contenido.</p>';
        }
    }

    // 2. Dibuja en pantalla los items
    function renderItems(itemsToRender) {
        container.innerHTML = ''; // Limpia el contenedor

        if (itemsToRender.length === 0) {
            container.innerHTML = `
                <div class="empty-catalog-message">
                    <h2>No se encontró contenido con estos filtros.</h2>
                </div>
            `;
            return;
        }

        itemsToRender.forEach(item => {
            let itemHtml = '';
            switch (item.tipo_archivo) {
                case 'video': itemHtml = crearFichaVideo(item); break;
                case 'libro': itemHtml = crearFichaLibro(item); break;
                case 'audiolibro': itemHtml = crearFichaAudioLibro(item); break;
                case 'musica': itemHtml = crearFichaMusica(item); break;
            }
            container.innerHTML += itemHtml;
        });
    }

    // 3. FUNCIÓN CENTRAL (Modificada para buscar por año)
    function applyFilters() {
        let filteredItems = allItems;

        // Primero, filtra por categoría
        if (currentCategory !== 'all') {
            filteredItems = filteredItems.filter(item => item.tipo_archivo === currentCategory);
        }

        // Segundo, filtra por el término de búsqueda
        if (currentSearchTerm) { 
            filteredItems = filteredItems.filter(item => {
                const searchTerm = currentSearchTerm.toLowerCase();
                
                const titulo = (item.titulo || '').toLowerCase();
                const autor = (item.autor || '').toLowerCase();
                const etiquetas = (item.etiquetas || []).join(' ').toLowerCase();
                const anio = (item.ano_publicacion || '').toString(); 

                return titulo.includes(searchTerm) ||
                       autor.includes(searchTerm) ||
                       etiquetas.includes(searchTerm) ||
                       anio.includes(searchTerm);
            });
        }

        renderItems(filteredItems);
    }

    // 4. Listener de categorías
    function setupCategoryListeners() {
        const filterList = document.querySelector('.tm-category-list'); 

        filterList.addEventListener('click', (e) => {
            e.preventDefault();
            const link = e.target.closest('.tm-category-link');
            if (!link) return;

            document.querySelector('.tm-category-link.active').classList.remove('active');
            link.classList.add('active');

            currentCategory = link.dataset.tipo;
            applyFilters();
        });
    }

    // --- 5. ¡FUNCIÓN MODIFICADA! ---
    // Mueve la lógica del 'input' al 'submit'
    function setupSearchListener() {
        const searchForm = document.getElementById('search-form');
        const searchInput = document.getElementById('search-input');

        // El formulario ahora maneja la lógica de búsqueda
        searchForm.addEventListener('submit', (e) => {
            e.preventDefault(); // Evita que la página se recargue
            
            // Actualiza la variable de estado con el valor del input
            currentSearchTerm = searchInput.value.trim();
            
            // Llama a la función central de filtrado
            applyFilters();
        });
    }
    // --- 6. NUEVA FUNCIÓN: Listener para el botón de limpiar ---
    function setupClearSearchListener() {
        const clearBtn = document.getElementById('clear-search-btn');

        console.log('Buscando el botón de limpiar:', clearBtn);
        const searchInput = document.getElementById('search-input');

        clearBtn.addEventListener('click', () => {
            // Limpia la variable de estado
            currentSearchTerm = '';
            // Limpia el campo de texto del buscador
            searchInput.value = '';
            // Vuelve a aplicar los filtros
            applyFilters();
        });
    }

    // --- (AQUÍ VAN TUS 4 FUNCIONES "crearFicha...") ---
    //
          function crearFichaVideo(item) {
            const etiquetasHtml = (item.etiquetas || []).map(tag => `<span class="tag">${tag}</span>`).join('');
            
            return `
            <div class="col-lg-4 col-md-6 col-sm-12 tm-catalog-item" data-id="${item._id}">
                <div class="position-relative tm-thumbnail-container">
                   <img src="${item.thumbnailId ? `/api/thumbnail/${item.thumbnailId}` : getPlaceholderImage(item.tipo_archivo)}" alt="${item.titulo}" class="img-fluid tm-catalog-item-img">
                    <a href="content-page.html?id=${item._id}" class="position-absolute tm-img-overlay">
                        <i class="fas fa-play tm-overlay-icon"></i>
                    </a>
                </div>
                <div class="p-4 tm-bg-gray tm-catalog-item-description">
                    <h3 class="tm-text-primary mb-3 tm-catalog-item-title">${item.titulo}</h3>
                    <ul class="video-meta">
                        <li><strong>Título:</strong> ${item.titulo}</li>
                        <li><strong>Autor:</strong> ${item.autor}</li>
                        <li><strong>Género:</strong> ${item.genero}</li>
                        <li><strong>Año:</strong> ${item.ano_publicacion}</li>
                        <li><strong>Descripción:</strong> ${item.descripcion}</li>
                        <li><strong>Etiquetas:</strong> </li>
                    </ul>
                    <div class="content-tags">${etiquetasHtml}</div>
                    <div class="contenedor-botones-acciones">
                        <button class="boton-accion boton-eliminar" data-id="${item._id}">
                            <i class="fas fa-trash-alt"></i> Eliminar
                        </button>
                        <a href="modificar.html?id=${item._id}" class="boton-accion boton-modificar">
                            <i class="fas fa-edit"></i> Modificar
                        </a>
                    </div>
                </div>
            </div>`;
        }

        function crearFichaLibro(item) {
            const etiquetasHtml = (item.etiquetas || []).map(tag => `<span class="tag">${tag}</span>`).join('');
            
            return `
            <div class="col-lg-4 col-md-6 col-sm-12 tm-catalog-item" data-id="${item._id}">
                <div class="position-relative tm-thumbnail-container">
                   <img src="${item.thumbnailId ? `/api/thumbnail/${item.thumbnailId}` : getPlaceholderImage(item.tipo_archivo)}" alt="${item.titulo}" class="img-fluid tm-catalog-item-img">
                   <a href="content-page.html?id=${item._id}" class="position-absolute audiolibro-img-overlay"></a>
                </div>    
                <div class="p-4 tm-bg-gray tm-catalog-item-description">
                    <h3 class="tm-text-primary mb-3 tm-catalog-item-title">${item.titulo}</h3>
                    <ul class="video-meta">
                        <li><strong>Título:</strong> ${item.titulo}</li>
                        <li><strong>Autor:</strong> ${item.autor}</li>
                        <li><strong>Género:</strong> ${item.genero}</li>
                        <li><strong>Paginas:</strong> ${item.paginas || 'N/A'}</li> 
                        <li><strong>Año de publicacion:</strong> ${item.ano_publicacion}</li>
                        <li><strong>Descripción:</strong> ${item.descripcion}</li>
                        <li><strong>Etiquetas:</strong> </li>
                    </ul>
                    <div class="content-tags">${etiquetasHtml}</div>
                    <div class="contenedor-botones-acciones">
                        <button class="boton-accion boton-eliminar" data-id="${item._id}">
                            <i class="fas fa-trash-alt"></i> Eliminar
                        </button>
                        <a href="modificar.html?id=${item._id}" class="boton-accion boton-modificar">
                            <i class="fas fa-edit"></i> Modificar
                        </a>
                    </div>
                </div>
            </div>`;
        }
        
        function crearFichaAudioLibro(item) {
            const etiquetasHtml = (item.etiquetas || []).map(tag => `<span class="tag">${tag}</span>`).join('');
            
            return `
            <div class="col-lg-4 col-md-6 col-sm-12 tm-catalog-item" data-id="${item._id}">
                <div class="position-relative tm-thumbnail-container">
                    <img src="${item.thumbnailId ? `/api/thumbnail/${item.thumbnailId}` : getPlaceholderImage(item.tipo_archivo)}" alt="${item.titulo}" class="img-fluid tm-catalog-item-img">
                    <a href="content-page.html?id=${item._id}" class="position-absolute audiolibro-img-overlay">
                        <i class="fas fa-play tm-overlay-icon"></i>
                    </a>
                </div>    
                <div class="p-4 tm-bg-gray tm-catalog-item-description">
                    <h3 class="tm-text-primary mb-3 tm-catalog-item-title">${item.titulo}</h3>
                    <ul class="video-meta">
                        <li><strong>Título:</strong> ${item.titulo}</li>
                        <li><strong>Autor:</strong> ${item.autor}</li>
                        <li><strong>Género:</strong> ${item.genero}</li>
                        <li><strong>Año de publicacion:</strong> ${item.ano_publicacion}</li>
                        <li><strong>Descripción:</strong> ${item.descripcion}</li>
                        <li><strong>Etiquetas:</strong> </li>
                    </ul>
                    <div class="content-tags">${etiquetasHtml}</div>
                    <div class="contenedor-botones-acciones">
                        <button class="boton-accion boton-eliminar" data-id="${item._id}">
                            <i class="fas fa-trash-alt"></i> Eliminar
                        </button>
                        <a href="modificar.html?id=${item._id}" class="boton-accion boton-modificar">
                            <i class="fas fa-edit"></i> Modificar
                        </a>
                    </div>
                </div>
            </div>`;
        }

        function crearFichaMusica(item) {
            const etiquetasHtml = (item.etiquetas || []).map(tag => `<span class="tag">${tag}</span>`).join('');
            
            return `
            <div class="col-lg-4 col-md-6 col-sm-12 tm-catalog-item" data-id="${item._id}">
                <div class="position-relative tm-thumbnail-container">
                    <img src="${item.thumbnailId ? `/api/thumbnail/${item.thumbnailId}` : getPlaceholderImage(item.tipo_archivo)}" alt="${item.titulo}" class="img-fluid tm-catalog-item-img">
                    <a href="content-page.html?id=${item._id}" class="position-absolute overlay-music">
                        <i class="fas fa-play tm-overlay-icon"></i>
                    </a>
                </div>    
                <div class="p-4 tm-bg-gray tm-catalog-item-description">
                    <h3 class="tm-text-primary mb-3 tm-catalog-item-title">${item.titulo}</h3>
                    <ul class="video-meta">
                        <li><strong>Título:</strong> ${item.titulo}</li>
                        <li><strong>Autor:</strong> ${item.autor}</li>
                        <li><strong>Género:</strong> ${item.genero}</li>
                        <li><strong>Año de publicacion:</strong> ${item.ano_publicacion}</li>
                        <li><strong>Descripción:</strong> ${item.descripcion}</li>
                        <li><strong>Etiquetas:</strong> </li>
                    </ul>
                    <div class="content-tags">${etiquetasHtml}</div>
                    <div class="contenedor-botones-acciones">
                        <button class="boton-accion boton-eliminar" data-id="${item._id}">
                            <i class="fas fa-trash-alt"></i> Eliminar
                        </button>
                        <a href="modificar.html?id=${item._id}" class="boton-accion boton-modificar">
                            <i class="fas fa-edit"></i> Modificar
                        </a>
                    </div>
                </div>
            </div>`;
        }

    //
    // Función de placeholder, por si acaso
    function getPlaceholderImage(tipo) {
        switch (tipo) {
            case 'video': return 'img/tn-01.jpg';
            case 'libro': return 'img/itportada.jpg';
            case 'audiolibro': return 'img/Libro_olvido.jpg';
            case 'musica': return 'img/daft.jpg';
            default: return 'img/tn-01.jpg';
        }
    }
</script>

    <script>
            // Lógica para manejar los clics de eliminación
            document.addEventListener('DOMContentLoaded', () => {
                const catalogoLista = document.getElementById('catalogo-lista');

                // 1. Escuchamos clics en toda la lista de contenido
                catalogoLista.addEventListener('click', async (e) => {
                    
                    // 2. Verificamos si el clic fue en un botón de eliminar
                    const deleteButton = e.target.closest('.boton-eliminar');
                    
                    if (deleteButton) {
                        e.preventDefault(); // Previene cualquier acción por defecto
                        
                        const card = deleteButton.closest('.tm-catalog-item');
                        const itemId = card.dataset.id; // Obtenemos el ID del item

                        // 3. PEDIMOS VERIFICACIÓN AL USUARIO
                        const wantsToDelete = confirm('¿Estás seguro de que deseas eliminar este contenido? Esta acción no se puede deshacer.');

                        if (wantsToDelete) {
                            // 4. Si el usuario confirma, enviamos la petición DELETE al servidor
                            try {
                                const response = await fetch(`/api/item/${itemId}`, {
                                    method: 'DELETE'
                                });

                                if (response.ok) {
                                    // 5. Eliminamos la tarjeta de la vista con una animación
                                    card.style.transition = 'opacity 0.5s ease';
                                    card.style.opacity = '0';
                                    setTimeout(() => card.remove(), 500);
                                } else {
                                    alert('Error: No se pudo eliminar el contenido.');
                                }
                            } catch (error) {
                                console.error('Error de red:', error);
                                alert('Error de red al intentar eliminar.');
                            }
                        }
                    }
                });
            });
    </script>

</body>

</html>